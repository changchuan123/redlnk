# RedInk 部署说明

## 本地调试完成

### 已完成的工作
1. ✅ 项目已克隆到本地
2. ✅ 创建了配置文件（文本生成使用 DeepSeek）
3. ✅ 创建了 Nano Banana 图片生成器（支持异步任务模式）
4. ✅ 后端依赖已安装
5. ✅ 前端依赖已安装并构建成功

### 配置文件说明

#### 文本生成配置 (`text_providers.yaml`)
- 使用 DeepSeek API（OpenAI 兼容接口）
- API Key: `sk-40a959e48f2d41569d4e98af96616cd0`
- Base URL: `https://api.deepseek.com/v1`
- Model: `deepseek-chat`

#### 图片生成配置 (`image_providers.yaml`)
- 使用 Nano Banana API（异步任务模式）
- **⚠️ 需要配置实际的 API Key**
- Base URL: `https://grsai.dakka.com.cn`
- Model: `nano-banana-fast`

### ⚠️ 重要提示

**在部署到服务器之前，需要：**

1. **配置 Nano Banana API Key**
   - 编辑 `image_providers.yaml`
   - 将 `api_key: sk-xxxxxxxxxxxxxxxxxxxx` 替换为实际的 API Key
   - 或者部署后在 Web 界面设置页面配置

2. **确认服务器环境**
   - Python 3.11+
   - Node.js 18+
   - pnpm
   - uv

## 服务器部署步骤

### 方式一：使用部署脚本（推荐）

```bash
# 确保已安装 sshpass（用于自动输入密码）
# macOS: brew install sshpass
# Ubuntu/Debian: apt-get install sshpass

cd /Users/weixiaogang/AI/redink
./deploy.sh
```

### 方式二：手动部署

#### 1. 上传项目到服务器

```bash
# 使用 rsync 上传（需要先安装 sshpass）
sshpass -p "Agenticseek1121" rsync -avz --exclude='.git' --exclude='.venv' --exclude='node_modules' \
    /Users/weixiaogang/AI/redink/ root@212.64.57.87:/opt/redink/
```

#### 2. 在服务器上安装依赖

```bash
# SSH 登录服务器
ssh root@212.64.57.87

# 进入项目目录
cd /opt/redink

# 安装 uv（如果未安装）
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.cargo/bin:$PATH"

# 安装后端依赖
uv sync

# 安装 Node.js 和 pnpm（如果未安装）
# Ubuntu/Debian:
# curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
# apt-get install -y nodejs
# npm install -g pnpm

# 构建前端
cd frontend
pnpm install
pnpm build
cd ..
```

#### 3. 配置 API Key

编辑配置文件或使用 Web 界面：

```bash
# 编辑配置文件
nano /opt/redink/image_providers.yaml
# 填入实际的 Nano Banana API Key
```

#### 4. 启动服务

**方式 A：使用 systemd（推荐）**

```bash
# 创建 systemd 服务文件
cat > /etc/systemd/system/redink.service << EOF
[Unit]
Description=RedInk 小红书图文生成器
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/redink
Environment="PATH=/root/.cargo/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/root/.cargo/bin/uv run python -m backend.app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl daemon-reload
systemctl enable redink
systemctl start redink

# 查看状态
systemctl status redink

# 查看日志
journalctl -u redink -f
```

**方式 B：使用 nohup（简单方式）**

```bash
cd /opt/redink
nohup uv run python -m backend.app > redink.log 2>&1 &
```

#### 5. 配置防火墙

```bash
# 开放 12398 端口
# Ubuntu/Debian:
ufw allow 12398/tcp

# CentOS/RHEL:
firewall-cmd --permanent --add-port=12398/tcp
firewall-cmd --reload
```

### 访问服务

部署完成后，访问：
- **服务地址**: http://212.64.57.87:12398
- **设置页面**: http://212.64.57.87:12398/#/settings

### 服务管理

```bash
# 查看服务状态
systemctl status redink

# 启动服务
systemctl start redink

# 停止服务
systemctl stop redink

# 重启服务
systemctl restart redink

# 查看日志
journalctl -u redink -f

# 查看最近 100 行日志
journalctl -u redink -n 100
```

## 故障排查

### 1. 服务无法启动

```bash
# 检查 Python 版本
python3 --version  # 需要 3.11+

# 检查依赖是否安装
cd /opt/redink
uv run python -c "import flask; print('OK')"

# 手动运行查看错误
uv run python -m backend.app
```

### 2. 端口被占用

```bash
# 查看端口占用
netstat -tlnp | grep 12398
# 或
lsof -i :12398

# 修改端口（编辑 backend/app.py）
```

### 3. API Key 配置问题

- 在 Web 界面设置页面检查 API Key 是否正确
- 查看日志确认错误信息
- 确认 API Key 有足够的配额

### 4. 图片生成失败

- 检查 Nano Banana API Key 是否有效
- 查看日志确认具体错误
- 确认网络连接正常

## 更新项目

```bash
# 1. 本地更新代码
cd /Users/weixiaogang/AI/redink
git pull

# 2. 重新构建前端
cd frontend
pnpm build

# 3. 上传到服务器
sshpass -p "Agenticseek1121" rsync -avz --exclude='.git' --exclude='.venv' --exclude='node_modules' \
    /Users/weixiaogang/AI/redink/ root@212.64.57.87:/opt/redink/

# 4. 在服务器上更新依赖并重启
ssh root@212.64.57.87 << 'ENDSSH'
    cd /opt/redink
    uv sync
    cd frontend
    pnpm install
    pnpm build
    systemctl restart redink
ENDSSH
```

## 注意事项

1. **API Key 安全**: 不要将 API Key 提交到 Git 仓库
2. **数据持久化**: 生成的图片保存在 `/opt/redink/output` 目录
3. **历史记录**: 历史记录保存在 `/opt/redink/history` 目录
4. **日志管理**: 定期清理日志文件，避免占用过多磁盘空间
5. **备份配置**: 定期备份配置文件，特别是 API Key 配置

## 技术支持

如有问题，请查看：
- 项目 GitHub: https://github.com/HisMax/RedInk
- 项目 Issues: https://github.com/HisMax/RedInk/issues

