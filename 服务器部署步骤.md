# RedInk 服务器部署步骤（简化版）

## 前置准备

### 1. 检查服务器环境

```bash
# SSH 登录服务器
ssh root@212.64.57.87

# 检查 Python 版本（需要 3.11+）
python3 --version

# 检查 Node.js 版本（需要 18+）
node --version

# 检查是否已安装 uv
uv --version
```

### 2. 安装必要的工具（如果未安装）

```bash
# 安装 Python 3.11（Ubuntu/Debian）
apt-get update
apt-get install -y python3.11 python3.11-venv python3.11-dev

# 安装 Node.js 18（使用 NodeSource）
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# 安装 pnpm
npm install -g pnpm

# 安装 uv
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.cargo/bin:$PATH"
```

## 部署步骤

### 步骤 1: 上传项目文件

**在本地执行：**

```bash
cd /Users/weixiaogang/AI/redink

# 使用 scp 上传（需要手动输入密码）
scp -r \
    --exclude='.git' \
    --exclude='.venv' \
    --exclude='node_modules' \
    --exclude='frontend/node_modules' \
    --exclude='frontend/dist' \
    . root@212.64.57.87:/opt/redink/
```

**或者使用 rsync（更推荐）：**

```bash
# 如果已安装 sshpass
sshpass -p "Agenticseek1121" rsync -avz \
    --exclude='.git' \
    --exclude='.venv' \
    --exclude='node_modules' \
    --exclude='frontend/node_modules' \
    --exclude='frontend/dist' \
    /Users/weixiaogang/AI/redink/ root@212.64.57.87:/opt/redink/
```

### 步骤 2: 在服务器上安装依赖

**SSH 登录服务器后执行：**

```bash
# 进入项目目录
cd /opt/redink

# 创建必要的目录
mkdir -p output history

# 安装后端依赖
uv sync

# 安装前端依赖并构建
cd frontend
pnpm install
pnpm build
cd ..
```

### 步骤 3: 配置 API Key

**编辑配置文件：**

```bash
# 编辑图片生成配置（需要填入实际的 Nano Banana API Key）
nano image_providers.yaml

# 或者使用 Web 界面配置（推荐）
# 启动服务后访问 http://212.64.57.87:12398/#/settings
```

### 步骤 4: 创建 systemd 服务

```bash
# 创建服务文件
cat > /etc/systemd/system/redink.service << 'EOF'
[Unit]
Description=RedInk 小红书图文生成器
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/redink
Environment="PATH=/root/.cargo/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/root/.cargo/bin/uv run python -m backend.app
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd
systemctl daemon-reload

# 启用服务（开机自启）
systemctl enable redink

# 启动服务
systemctl start redink

# 查看服务状态
systemctl status redink
```

### 步骤 5: 配置防火墙

```bash
# Ubuntu/Debian
ufw allow 12398/tcp
ufw reload

# CentOS/RHEL
firewall-cmd --permanent --add-port=12398/tcp
firewall-cmd --reload
```

### 步骤 6: 验证部署

```bash
# 查看服务日志
journalctl -u redink -f

# 测试访问（在浏览器中）
# http://212.64.57.87:12398
```

## 快速命令参考

```bash
# 查看服务状态
systemctl status redink

# 启动服务
systemctl start redink

# 停止服务
systemctl stop redink

# 重启服务
systemctl restart redink

# 查看日志
journalctl -u redink -f

# 查看最近 100 行日志
journalctl -u redink -n 100

# 查看错误日志
journalctl -u redink -p err
```

## 常见问题

### 1. 服务启动失败

```bash
# 检查 Python 和依赖
cd /opt/redink
uv run python -c "import flask; print('OK')"

# 手动运行查看错误
uv run python -m backend.app
```

### 2. 端口被占用

```bash
# 查看端口占用
lsof -i :12398
# 或
netstat -tlnp | grep 12398
```

### 3. 权限问题

```bash
# 确保目录权限正确
chown -R root:root /opt/redink
chmod -R 755 /opt/redink
```

## 更新项目

```bash
# 1. 在本地更新代码
cd /Users/weixiaogang/AI/redink
git pull

# 2. 重新构建前端
cd frontend
pnpm build

# 3. 上传到服务器（使用上面的 scp 或 rsync 命令）

# 4. 在服务器上更新并重启
ssh root@212.64.57.87 << 'ENDSSH'
    cd /opt/redink
    uv sync
    cd frontend
    pnpm install
    pnpm build
    systemctl restart redink
ENDSSH
```

