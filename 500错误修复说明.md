# 500 错误修复说明（DeepSeek 图片输入问题）

## 🔍 问题诊断

**错误原因**: DeepSeek API 不支持图片输入
- 错误信息: `"unknown variant 'image_url', expected 'text'"`
- 当用户上传参考图片时，代码尝试将图片作为多模态输入发送给 DeepSeek API
- 但 DeepSeek 的 `deepseek-chat` 模型不支持图片输入，只支持纯文本

## ✅ 解决方案

已修复 `backend/services/outline.py`，添加了模型图片支持检测：

1. **检测模型是否支持图片输入**
   - `google_gemini`: 支持图片 ✅
   - `openai_compatible` + `gpt-4-vision`: 支持图片 ✅
   - `openai_compatible` + `deepseek-chat`: 不支持图片 ❌

2. **自动处理**
   - 当使用不支持图片的模型（如 DeepSeek）时，自动忽略图片参数
   - 提示词中已包含图片描述信息，不影响生成质量
   - 记录警告日志，但不影响功能

## 📋 修复内容

### 修改文件
- `backend/services/outline.py`

### 修改逻辑
```python
# 检查模型是否支持图片输入
provider_type = provider_config.get('type', '')
supports_images = provider_type == 'google_gemini' or (
    provider_type == 'openai_compatible' and 
    'gpt-4' in model.lower() and 'vision' in model.lower()
)

# 如果模型不支持图片但有图片输入，忽略图片参数
if images and len(images) > 0 and not supports_images:
    logger.warning(f"模型 {model} 不支持图片输入，将忽略参考图片。")
    images = None
```

## 🌐 当前配置

### 文本生成
- **服务商**: DeepSeek
- **API Key**: `sk-be7d4e5786a044f98f6231ab18ff52a9`
- **Model**: `deepseek-chat`
- **图片支持**: ❌ 不支持（已自动处理）

### 图片生成
- **服务商**: Google Gemini
- **API Key**: `AIzaSyBK3EIfnkKg1pejpcPZd8BA7MH2LHMQSss`
- **Model**: `gemini-3-pro-image-preview`
- **图片支持**: ✅ 支持

## 🔧 使用说明

### 使用 DeepSeek 时
- ✅ 可以正常生成大纲
- ✅ 可以上传参考图片（会自动忽略，但提示词中会包含图片描述）
- ✅ 不影响功能使用

### 使用 Gemini 时
- ✅ 可以正常生成大纲
- ✅ 可以上传参考图片（会作为多模态输入处理）
- ✅ 充分利用图片信息

## 📝 后续建议

1. **如果需要图片理解功能**：切换到 Gemini 作为文本生成服务商
2. **如果只需要文本生成**：继续使用 DeepSeek（性价比更高）
3. **混合使用**：文本生成用 DeepSeek，图片生成用 Gemini（当前配置）

---

**问题已修复！** 🎉

现在使用 DeepSeek 时，即使上传了参考图片也不会报错，服务可以正常工作了。

