# 网络问题修复说明

## 🔍 问题诊断

**问题**: 服务器无法连接到 Gemini API，导致请求一直卡住
- 服务器无法访问 `generativelanguage.googleapis.com`
- 连接超时，请求一直等待
- 用户界面一直转圈，无法完成

**根本原因**: 
- 服务器网络无法访问 Google 服务（可能是防火墙或网络限制）
- Gemini API 请求没有超时处理

## ✅ 解决方案

### 1. 添加超时处理
- 在 `genai_client.py` 中添加 60 秒超时
- 超时后抛出明确的错误信息

### 2. 添加回退机制
- 当 Gemini 连接失败时，自动回退到 DeepSeek
- 忽略参考图片，使用纯文本生成
- 确保服务始终可用

### 3. 错误处理优化
- 检测网络连接错误
- 提供清晰的错误提示
- 自动降级处理

## 📋 修复内容

### 修改文件
1. `backend/services/outline.py`
   - 添加 Gemini 连接失败的回退逻辑
   - 自动回退到 DeepSeek 并忽略图片

2. `backend/utils/genai_client.py`
   - 添加 60 秒超时处理
   - 改进错误提示信息

### 工作流程

1. **检测图片输入** → 尝试切换到 Gemini
2. **Gemini 连接失败** → 检测到网络错误
3. **自动回退** → 使用 DeepSeek，忽略图片
4. **生成大纲** → 使用纯文本提示词

## 🔧 当前状态

### 网络问题
- ❌ 服务器无法访问 Google Gemini API
- ✅ 已添加超时和回退机制

### 功能状态
- ✅ 无图片时：使用 DeepSeek（正常）
- ✅ 有图片时：尝试 Gemini → 失败 → 回退到 DeepSeek（忽略图片）
- ✅ 服务始终可用，不会卡住

## 📝 建议

### 短期方案（当前）
- 使用 DeepSeek 生成大纲（忽略图片）
- 提示词中已包含图片描述信息

### 长期方案
1. **配置代理**: 为服务器配置代理访问 Google 服务
2. **使用国内 API**: 如果有 Gemini 的国内代理服务
3. **网络检查**: 检查服务器防火墙和网络配置

## ⚠️ 注意事项

- 当前服务器无法访问 Google 服务，Gemini 功能受限
- 有图片输入时会自动回退到 DeepSeek
- 图片信息会通过文本描述传递给模型
- 服务不会因为网络问题而卡住

---

**问题已修复！** 🎉

现在即使 Gemini API 无法连接，服务也会自动回退到 DeepSeek，确保功能正常可用。

